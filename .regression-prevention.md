# Regression Prevention Guide

## Critical Routes That Must Always Work

### 1. Authentication Routes
**Frontend calls:** `/api/auth/login` and `/api/auth/refresh`
**Gateway routes:** Must proxy to `http://localhost:3016` (default, configurable via `AUTH_SERVICE_PORT`)
**Auth service endpoint:** `/api/auth/login`
**Auth service port:** `3016` (default, set via `PORT` env var in startup script)

**⚠️ IMPORTANT:** 
- Gateway MUST have `/api/auth` route BEFORE any other `/api/*` routes
- Route order matters in Express - more specific routes must come first
- Always test login after any gateway changes

### 2. Applicant Routes
**Frontend calls:** `/api/applicants/:id` (PUT for create/update)
**Gateway routes:** Must proxy to `http://localhost:3003` (KYC service)
**KYC service endpoint:** `/api/applicants/:id`
**⚠️ IMPORTANT:** `/api/applicants` route MUST come BEFORE `/api/applications` in gateway to avoid route conflicts

### 3. Application Routes
**Frontend calls:** `/api/applications/*`
**Gateway routes:** Must proxy to `http://localhost:3001`
**Application service base:** `/api/applications`

### 4. Dashboard Routes
**Frontend calls:** `/api/applications/rm/dashboard`
**Gateway routes:** Must proxy with user headers
**Application service endpoint:** `/api/applications/rm/dashboard`

## Testing Checklist (Run After Any Changes)

1. ✅ Login works: `curl -X POST http://localhost:3000/api/auth/login -d '{"username":"rm1","password":"rm1Rm@123456"}'`
2. ✅ Gateway health: `curl http://localhost:3000/health`
3. ✅ Auth service health: `curl http://localhost:3016/health` (default port) or `curl http://localhost:3002/health` (if PORT=3002)
4. ✅ Application service health: `curl http://localhost:3001/health`
5. ✅ Dashboard accessible after login

## Common Regression Issues

### Issue 1: "Cannot POST /api/auth/login"
**Cause:** Gateway missing `/api/auth` route
**Fix:** Add `/api/auth` route BEFORE other `/api/*` routes
**Prevention:** Keep route order: `/api/auth` → `/api/applicants` → `/api/applications` → other `/api/*`

### Issue 1a: "Timeout while creating new application" or "Cannot PUT /api/applicants/:id"
**Cause:** Gateway missing `/api/applicants` route
**Fix:** Add `/api/applicants` route BEFORE `/api/applications` route, proxy to KYC service (port 3003)
**Prevention:** Keep `/api/applicants` route before `/api/applications` in gateway route order

### Issue 2: New application creation times out
**Cause:** Gateway missing `/api/applicants` route, OR service port mismatch (gateway expects 3003, service runs on 3002)
**Fix:** 
1. Add `/api/applicants` route that proxies to KYC service (port 3003)
2. Ensure KYC service runs on port 3003 (default changed from 3002 to 3003)
3. Always use `./scripts/start-all-services.sh` which sets correct PORT env vars
**Prevention:** 
- Ensure `/api/applicants` route exists and comes before `/api/applications`
- Verify service ports match gateway expectations: `./scripts/verify-service-ports.sh`
- Never manually restart services - always use the startup script

### Issue 3: Dashboard shows 0 values
**Cause:** User headers not forwarded to application service
**Fix:** Ensure `setUserHeaders` is called before proxy middleware

### Issue 4: Login successful but dashboard fails
**Cause:** Token validation mismatch (Keycloak vs JWT)
**Fix:** Ensure `requireAuth` supports both HS256 and RS256

## Route Order in Gateway (CRITICAL)

```typescript
// 1. Health/metrics (no auth)
app.get('/health', ...)
app.get('/metrics', ...)

// 2. Auth routes (public, MUST come first)
app.use('/api/auth', ...)  // ← MUST be before other /api/* routes
app.use('/auth', ...)      // ← Backward compatibility

// 3. Protected API routes (require auth, order matters!)
app.use('/api/applicants', requireAuth, ...)  // ← MUST be before /api/applications
app.use('/api/applications', requireAuth, ...)
app.use('/api/...', requireAuth, ...)

// 4. Service routes (require auth)
app.use('/kyc', requireAuth, ...)
app.use('/application', requireAuth, ...)
```

## Automated Testing

### Route Audit
Run to check all routes are properly configured:
```bash
./scripts/audit-gateway-routes.sh
```

This script verifies:
- All frontend endpoints have gateway routes
- Critical route order is correct
- No route conflicts

### Login Flow Test
Run after any changes:
```bash
./scripts/verify-login-flow.sh
```

This script tests:
- Gateway health
- Auth service health  
- Direct auth login
- Gateway /api/auth/login route
- Frontend proxy (if running)

### Pre-commit Check
Before committing gateway changes, run:
```bash
./scripts/pre-commit-gateway-check.sh
```

This ensures route order is correct and prevents breaking changes.

### Service Port Verification
After restarting services, verify ports match gateway expectations:
```bash
./scripts/verify-service-ports.sh
```

This checks that all services are running on ports the gateway expects.
**CRITICAL:** Always use `./scripts/start-all-services.sh` to start services, not manual restarts!

## Quick Fixes

### If login fails:
1. Check gateway route order
2. Verify auth service is running: `lsof -ti:3016` (default) or `lsof -ti:3002` (if PORT env set)
3. Test direct auth service: `curl -X POST http://localhost:3016/api/auth/login ...`
4. Check gateway target: Should be `http://localhost:3016` (or PORT env var)
4. Check gateway logs: `tail -f /tmp/los-services/gateway.log`

### If dashboard fails:
1. Check user headers are set: Look for `X-User-Id` in logs
2. Verify application service is running: `lsof -ti:3001`
3. Test dashboard endpoint directly with token

